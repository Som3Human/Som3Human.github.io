<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8">
  <title>YouTube Muzikos Viktorina</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 40px; }
    textarea { width: 80%; height: 120px; margin-bottom: 10px; }
    input[type="file"], input[type="text"] { margin-bottom: 10px; }
    #quiz { margin-top: 20px; display: none; }
    #player { width: 1px; height: 1px; overflow: hidden; }
    label { display: inline-flex; align-items: center; gap: 5px; margin: 10px; }
    select { margin: 10px; }
    button { margin: 5px; }
    #importExportPanel {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #f0f0f0;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      z-index: 1000;
    }
  </style>
</head>
<body>
  <h1>🎵 YouTube Muzikos Viktorina</h1>

  <div id="importExportPanel">
    <button onclick="exportPlaylists()">📤 Eksportuoti JSON</button>
    <input type="file" id="importFile" style="display:none">
    <button onclick="importPlaylists()">📥 Importuoti JSON</button>
  </div>

  <p>Pasirink grojaraštį arba įkelk savo:</p>
  <select id="presetList" onchange="loadPreset()">
    <option value="">-- Pasirink sąrašą --</option>
  </select>
  <button onclick="deletePlaylist()">🗑 Ištrinti (tik savo)</button>
  <br><br>

  <p>Arba įklijuok YouTube nuorodas (po vieną eilutėje) arba įkelk .txt failą:</p>
  <textarea id="links"></textarea><br>
  <input type="file" id="fileInput"><br>

  <p>Išsaugok kaip naują grojaraštį:</p>
  <input type="text" id="playlistName" placeholder="Grojaraščio pavadinimas">
  <button onclick="savePlaylist()">💾 Išsaugoti</button>
  <br><br>

  <label>
    <input type="checkbox" id="randomTime"> Groti nuo atsitiktinės vietos
  </label><br>

  <button id="playStopBtn" onclick="togglePlay()">▶️ Groti / Sustabdyti</button>
  <button onclick="nextSong()">Kitas kūrinys</button>

  <div id="quiz">
    <p>Dabar groja daina... Atspėk jos pavadinimą!</p>
    <input type="text" id="guess" placeholder="Tavo spėjimas">
    <button onclick="checkGuess()">Pateikti</button>
    <p id="result"></p>
  </div>

  <div id="player"></div>

  <script>
    let player;
    let songs = [];
    let currentSong = null;
    let playerReady = false;
    let isPlaying = false;

    const defaultPlaylists = {
      "Bandymas": [
        "https://youtu.be/Lxj4WnvBH8E?si=TOtTYu2KLZlhtcV3",
        "https://youtu.be/To1speljU44?si=ID0rNxgwUJk8Rxpf"
      ]
    };

    let tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);

    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '1',
        width: '1',
        events: {
          'onReady': () => { playerReady = true; refreshPlaylists(); },
          'onStateChange': onPlayerStateChange
        }
      });
    }

    function onPlayerStateChange(event) {
      isPlaying = event.data === YT.PlayerState.PLAYING;
      updatePlayStopBtn();
    }

    function updatePlayStopBtn() {
      document.getElementById("playStopBtn").textContent = isPlaying ? "⏸ Sustabdyti" : "▶️ Groti";
    }

    document.getElementById('fileInput').addEventListener('change', function(e) {
      let file = e.target.files[0];
      if (!file) return;
      let reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('links').value = e.target.result;
      };
      reader.readAsText(file);
    });

    function savePlaylist() {
      let name = document.getElementById("playlistName").value.trim();
      let text = document.getElementById('links').value.trim();
      if (!name) { alert("Įrašyk grojaraščio pavadinimą."); return; }
      if (!text) { alert("Nėra nuorodų, kurias išsaugoti."); return; }
      let playlists = JSON.parse(localStorage.getItem("playlists") || "{}");
      playlists[name] = text.split(/\s+/).filter(url => extractVideoId(url));
      localStorage.setItem("playlists", JSON.stringify(playlists));
      refreshPlaylists();
      alert("Išsaugotas grojaraštis: " + name);
      document.getElementById("playlistName").value = "";
    }

    function refreshPlaylists() {
      let userPlaylists = JSON.parse(localStorage.getItem("playlists") || "{}");
      let allPlaylists = { ...defaultPlaylists, ...userPlaylists };
      let select = document.getElementById("presetList");
      select.innerHTML = '<option value="">-- Pasirink sąrašą --</option>';
      for (let name in allPlaylists) {
        let option = document.createElement("option");
        option.value = name;
        option.textContent = name;
        select.appendChild(option);
      }
    }

    function loadPreset() {
      let choice = document.getElementById("presetList").value;
      if (!choice) return;
      let userPlaylists = JSON.parse(localStorage.getItem("playlists") || "{}");
      let allPlaylists = { ...defaultPlaylists, ...userPlaylists };
      if (allPlaylists[choice]) {
        document.getElementById('links').value = allPlaylists[choice].join("\n");
      }
    }

    function deletePlaylist() {
      let choice = document.getElementById("presetList").value;
      if (!choice) { alert("Nepasirinktas joks grojaraštis."); return; }
      let userPlaylists = JSON.parse(localStorage.getItem("playlists") || "{}");
      if (defaultPlaylists[choice]) { alert("Numatytų grojaraščių ištrinti negalima."); return; }
      if (userPlaylists[choice]) {
        delete userPlaylists[choice];
        localStorage.setItem("playlists", JSON.stringify(userPlaylists));
        refreshPlaylists();
        alert("Ištrintas grojaraštis: " + choice);
        document.getElementById('links').value = "";
      }
    }

    function startQuiz() {
      let text = document.getElementById('links').value.trim();
      songs = text.split(/\s+/).filter(url => extractVideoId(url));
      if (songs.length === 0) { alert("Nerasta dainų!"); return; }
      document.getElementById('quiz').style.display = "block";
      playRandomSong();
    }

    function nextSong() {
      if (songs.length === 0) { alert("Nėra įkeltų dainų!"); return; }
      playRandomSong();
    }

    function playRandomSong() {
      if (!playerReady) { alert("Grotuvas dar nepasiruošęs."); return; }
      currentSong = songs[Math.floor(Math.random() * songs.length)];
      let videoId = extractVideoId(currentSong);
      let duration = player.getDuration();
      let useRandom = document.getElementById("randomTime").checked;
      let startTime = 0;
      if (useRandom && duration > 0) startTime = Math.floor(Math.random() * Math.max(1, duration - 30));
      player.loadVideoById({ videoId: videoId, startSeconds: startTime });
      document.getElementById('result').innerHTML = "";
      document.getElementById('guess').value = "";
      isPlaying = true; updatePlayStopBtn();
    }

    function togglePlay() {
      if (!playerReady) return;
      let text = document.getElementById('links').value.trim();
      let newSongs = text.split(/\s+/).filter(url => extractVideoId(url));
      if (!currentSong || songs.join() !== newSongs.join()) {
        songs = newSongs;
        if (songs.length === 0) { alert("Nerasta dainų!"); return; }
        startQuiz();
      } else if (isPlaying) {
        player.pauseVideo();
      } else {
        player.playVideo();
      }
    }

    function extractVideoId(url) {
      try {
        let u = new URL(url);
        if (u.hostname.includes("youtu.be")) return u.pathname.substring(1);
        else if (u.searchParams.get("v")) return u.searchParams.get("v");
      } catch { return null; }
      return null;
    }

    function checkGuess() {
      let guess = document.getElementById('guess').value.trim();
      let videoData = player.getVideoData();
      let realTitle = videoData.title || "(nežinomas pavadinimas)";
      document.getElementById('result').innerHTML =
        "Tavo spėjimas: <b>" + guess + "</b><br>Teisingas atsakymas: <b>" + realTitle + "</b>";
    }

    function exportPlaylists() {
      let playlists = JSON.parse(localStorage.getItem("playlists") || "{}");
      let dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(playlists));
      let dlAnchor = document.createElement('a');
      dlAnchor.setAttribute("href", dataStr);
      dlAnchor.setAttribute("download", "playlists.json");
      document.body.appendChild(dlAnchor);
      dlAnchor.click();
      dlAnchor.remove();
    }

    document.getElementById('importFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const imported = JSON.parse(e.target.result);
          if (typeof imported === "object") {
            let playlists = JSON.parse(localStorage.getItem("playlists") || "{}");
            playlists = { ...playlists, ...imported };
            localStorage.setItem("playlists", JSON.stringify(playlists));
            refreshPlaylists();
            alert("Grojaraščiai sėkmingai importuoti!");
          } else alert("Failas netinkamo formato.");
        } catch {
          alert("Nepavyko importuoti JSON failo.");
        }
      };
      reader.readAsText(file);
    });

    function importPlaylists() {
      document.getElementById('importFile').click();
    }
  </script>
</body>
</html>
